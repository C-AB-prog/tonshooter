generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
Ñƒ  id                 String   @id @default(cuid())
  tgUserId            BigInt   @unique
  username           String?
  firstName          String?
  lastName           String?
  createdAt          DateTime @default(now())

  coins              BigInt   @default(0)
  crystals           BigInt   @default(0)
  tonBalance         Decimal  @default(0) @db.Decimal(18, 9)

  weaponLevel        Int      @default(1)
  rangeLevel         Int      @default(1)

  energy             Int      @default(100)
  energyUpdatedAt    DateTime @default(now())

  difficulty         Int      @default(0) // consecutive hits; resets to 0 on miss

  // --- Referral / activity counters (for future referral system)
  shotsCount         Int      @default(0)
  hitsCount          Int      @default(0)
  referralQualifiedAt DateTime?
  referralRewardedAt  DateTime?

  boostActiveUntil   DateTime?
  boostCooldownUntil DateTime?

  // Connected wallet address (TonConnect)
  tonWalletAddress   String?
  tonWalletUpdatedAt DateTime?

  isBotBlocked       Boolean  @default(false)
  suspicionScore     Int      @default(0)

  referrerId         String?
  referrer           User?    @relation("UserRef", fields: [referrerId], references: [id])
  referrals          User[]   @relation("UserRef")

  lastWithdrawalAt   DateTime?

  actions            ActionLog[]
  shotSessions       ShotSession[]
  taskClaims         TaskClaim[]
  taskOpens          TaskOpen[]
  withdrawals        Withdrawal[]
  purchases          Purchase[]
}

enum ShotMode {
  PINGPONG
  WRAP
}

model ShotSession {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())

  // Difficulty snapshot at start
  difficulty    Int
  // config (normalized 0..1)
  mode          ShotMode @default(PINGPONG)
  zoneCenter    Float
  zoneWidth     Float
  speed         Float // cycles per second
  // Optional moving green zone (enabled after 3 hits sometimes)
  zoneMoves     Boolean @default(false)
  // Phase offset for zone motion (0..2)
  zonePhase     Float   @default(0)
  baseStartedAt DateTime

  used          Boolean  @default(false)

  @@index([userId, createdAt])
}

model ActionLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  createdAt DateTime @default(now())
  meta      Json?
  @@index([userId, createdAt])
  @@index([type, createdAt])
}

model Task {
  id          String   @id @default(cuid())
  title       String
  description String
  chatId      String   // @channelusername or numeric id
  url         String   // where to open (t.me/...)
  cap         Int      @default(0) // max number of successful claims (0 = unlimited)
  completedCount Int   @default(0)
  requireSubscriptionCheck Boolean @default(false)
  rewardType  RewardType
  rewardValue Int      // coins or crystals amount
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  claims      TaskClaim[]
  opens       TaskOpen[]
}

model TaskOpen {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id])
  openedAt  DateTime @default(now())
  openToken String?
  openTokenExpiresAt DateTime?

  @@unique([userId, taskId])
  @@index([taskId, openedAt])
}

model TaskClaim {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, taskId])
}

model Withdrawal {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  amountTon Decimal  @db.Decimal(18, 9)
  address   String
  devFeeTon Decimal  @db.Decimal(18, 9)
  status    WithdrawalStatus @default(PENDING)
  processedAt DateTime?
  txHash     String?
  adminNote  String?
}

enum RewardType {
  COINS
  CRYSTALS
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  SENT
  REJECTED
}



enum PurchaseItem {
  BOOST
  UPGRADE_WEAPON_5
  UPGRADE_RANGE_5
}

enum PurchaseStatus {
  PENDING
  PAID
  FAILED
}

model Purchase {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())

  item       PurchaseItem
  amountNano BigInt
  receiver   String
  comment    String
  sender     String?
  txHash     String?
  status     PurchaseStatus @default(PENDING)
  paidAt     DateTime?

  @@index([userId, createdAt])
  @@unique([receiver, comment])
}

